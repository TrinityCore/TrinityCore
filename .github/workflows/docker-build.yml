# --- Stage 1: Builder ---
# Wir nutzen jetzt Ubuntu 24.04, da dies CMake 3.28 enthält (Trinity braucht 3.24+)
FROM ubuntu:24.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Abhängigkeiten für Ubuntu 24.04
# libmariadb-dev-compat wird genutzt, default-libmysqlclient-dev ist entfernt
RUN apt-get update && apt-get install -y \
    git clang cmake make gcc g++ libmariadb-dev libssl-dev \
    libbz2-dev libreadline-dev libncurses-dev \
    libboost-all-dev p7zip \
    libmariadb-dev-compat gettext curl unzip \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src

# TrinityCore Master klonen
RUN git clone -b master --depth 1 https://github.com/TrinityCore/TrinityCore.git

WORKDIR /usr/src/TrinityCore/build

# CMake konfigurieren
RUN cmake ../ -DCMAKE_INSTALL_PREFIX=/opt/trinitycore \
    -DCMAKE_C_COMPILER=clang \
    -DCMAKE_CXX_COMPILER=clang++ \
    -DWITH_WARNINGS=0 \
    -DTOOLS=1 \
    -DSCRIPTS=static

# Kompilieren (GitHub Action regelt die Kerne, sonst nproc)
RUN make -j$(nproc) && make install

# SQL Dateien sichern
RUN cp -r /usr/src/TrinityCore/sql /opt/trinitycore/sql


# --- Stage 2: Runtime ---
FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# Laufzeit-Abhängigkeiten für Ubuntu 24.04 (angepasste Paketnamen!)
# Beachte: libssl3t64 und Boost 1.83.0 sind spezifisch für Ubuntu 24.04
RUN apt-get update && apt-get install -y \
    libmariadb3 \
    libssl3t64 \
    libboost-system1.83.0 \
    libboost-filesystem1.83.0 \
    libboost-thread1.83.0 \
    libboost-program-options1.83.0 \
    libboost-iostreams1.83.0 \
    libreadline8t64 \
    libncurses6 \
    netcat-openbsd iputils-ping \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /opt/trinitycore

# Kopiere die kompilierten Dateien
COPY --from=builder /opt/trinitycore /opt/trinitycore

# Kopiere Script
COPY scripts/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# User anlegen
RUN groupadd -r trinity && useradd -r -g trinity trinity
RUN chown -R trinity:trinity /opt/trinitycore

# Ports
EXPOSE 3724 8085

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
