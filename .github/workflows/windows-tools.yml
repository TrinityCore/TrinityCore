name: Build Windows Tools Only

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
    paths:
      - 'src/tools/**'
      - '.github/workflows/windows-tools.yml'

jobs:
  build-tools:
    name: Build Tools (Windows)
    runs-on: windows-2022
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Comment: Install OpenSSL and Boost explicitly using Chocolatey.
      # This guarantees we know exactly where they are installed.
      # boost-msvc-14.3 matches Visual Studio 2022 (v143).
      - name: Install Dependencies
        run: |
          choco install openssl --version 1.1.1.2100 -y --no-progress
          choco install boost-msvc-14.3 -y --no-progress
      
      - name: Configure CMake
        shell: cmd
        # Comment: Configure CMake with fixed paths.
        # Chocolatey installs OpenSSL to C:/Program Files/OpenSSL
        # Chocolatey installs Boost to C:/local/boost_<version> usually, but we let CMake find it now that it's standard.
        run: |
          mkdir build
          cd build
          cmake ../ ^
            -G "Visual Studio 17 2022" ^
            -A x64 ^
            -DTOOLS=1 ^
            -DSERVERS=0 ^
            -DSCRIPTS=0 ^
            -DWITH_WARNINGS=0 ^
            -DOPENSSL_ROOT_DIR="C:/Program Files/OpenSSL" ^
            -DOPENSSL_INCLUDE_DIR="C:/Program Files/OpenSSL/include"

      - name: Build Tools
        shell: cmd
        # Comment: Build the tools in Release mode
        run: |
          cd build
          cmake --build . --config Release --target mapextractor vmap4extractor vmap4assembler mmaps_generator --parallel 4

      - name: Package Tools
        shell: cmd
        # Comment: Package binaries and DLLs.
        # Note: OpenSSL path updated to C:\Program Files\OpenSSL
        run: |
          mkdir TrinityTools
          
          echo Copying executables...
          copy build\bin\Release\mapextractor.exe TrinityTools\
          copy build\bin\Release\vmap4extractor.exe TrinityTools\
          copy build\bin\Release\vmap4assembler.exe TrinityTools\
          copy build\bin\Release\mmaps_generator.exe TrinityTools\
          
          echo Copying OpenSSL DLLs...
          if exist "C:\Program Files\OpenSSL\bin\libcrypto-1_1-x64.dll" (
              copy "C:\Program Files\OpenSSL\bin\libcrypto-1_1-x64.dll" TrinityTools\
              copy "C:\Program Files\OpenSSL\bin\libssl-1_1-x64.dll" TrinityTools\
          ) else (
              echo WARNING: OpenSSL DLLs not found in expected path. Listing bin dir:
              dir "C:\Program Files\OpenSSL\bin"
          )

          echo Tools packaged successfully.

      - name: Upload Tools Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrinityCore-Windows-Tools
          path: TrinityTools
          compression-level: 9
          retention-days: 5
