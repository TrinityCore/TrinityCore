name: Build Windows Tools Only

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
    paths:
      - 'src/tools/**'
      - '.github/workflows/windows-tools.yml'

jobs:
  build-tools:
    name: Build Tools (Windows)
    runs-on: windows-2022
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Comment: Install OpenSSL dependency via Chocolatey
      - name: Install Dependencies
        run: |
          choco install openssl --version 1.1.1.2100 -y --no-progress
      
      # Comment: Find the pre-installed Boost version on the GitHub Runner.
      # GitHub stores it in variables like BOOST_ROOT_1_83_0, but CMake needs BOOST_ROOT.
      - name: Set Boost Environment
        shell: pwsh
        run: |
          $boostVar = Get-ChildItem env: | Where-Object { $_.Name -match '^BOOST_ROOT_\d+_\d+_\d+$' } | Sort-Object Name -Descending | Select-Object -First 1
          if ($boostVar) {
              Write-Host "Found pre-installed Boost: $($boostVar.Name) at $($boostVar.Value)"
              echo "BOOST_ROOT=$($boostVar.Value)" >> $env:GITHUB_ENV
          } else {
              Write-Error "No Boost installation found on this runner!"
              exit 1
          }

      - name: Configure CMake
        shell: cmd
        # Comment: Configure CMake explicitly.
        # We pass -DBOOST_ROOT using the variable we found in the previous step.
        run: |
          mkdir build
          cd build
          cmake ../ ^
            -G "Visual Studio 17 2022" ^
            -A x64 ^
            -DTOOLS=1 ^
            -DSERVERS=0 ^
            -DSCRIPTS=0 ^
            -DWITH_WARNINGS=0 ^
            -DBOOST_ROOT="%BOOST_ROOT%" ^
            -DOPENSSL_ROOT_DIR="C:/Program Files/OpenSSL-Win64" ^
            -DOPENSSL_INCLUDE_DIR="C:/Program Files/OpenSSL-Win64/include"

      - name: Build Tools
        shell: cmd
        # Comment: Build the tools in Release mode
        run: |
          cd build
          cmake --build . --config Release --target mapextractor vmap4extractor vmap4assembler mmaps_generator --parallel 4

      - name: Package Tools
        shell: cmd
        # Comment: Copy the binaries and the required DLLs into one folder
        run: |
          mkdir TrinityTools
          
          echo Copying executables...
          copy build\bin\Release\mapextractor.exe TrinityTools\
          copy build\bin\Release\vmap4extractor.exe TrinityTools\
          copy build\bin\Release\vmap4assembler.exe TrinityTools\
          copy build\bin\Release\mmaps_generator.exe TrinityTools\
          
          echo Copying OpenSSL DLLs...
          copy "C:\Program Files\OpenSSL-Win64\bin\libcrypto-1_1-x64.dll" TrinityTools\
          copy "C:\Program Files\OpenSSL-Win64\bin\libssl-1_1-x64.dll" TrinityTools\
          
          echo Tools packaged successfully.

      - name: Upload Tools Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrinityCore-Windows-Tools
          path: TrinityTools
          compression-level: 9
          retention-days: 5
