name: Build Windows Tools Only

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
    paths:
      - 'src/tools/**'
      - '.github/workflows/windows-tools.yml'

jobs:
  build-tools:
    name: Build Tools (Windows)
    runs-on: windows-2022
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Comment: Install dependencies adhering to TrinityCore Windows Requirements.
      # We use Chocolatey to fetch the exact libraries needed for Visual Studio 2022.
      - name: Install Dependencies
        shell: pwsh
        run: |
          # Install OpenSSL (Lightweight)
          Write-Host "Installing OpenSSL..."
          choco install openssl --version 1.1.1.2100 -y --no-progress
          
          # Install MySQL (Required for Common linking, even if Tools don't use DB directly)
          Write-Host "Installing MySQL..."
          choco install mysql --version 8.0.28 -y --no-progress

          # Install Boost for MSVC 14.3 (VS2022)
          # This installs to C:\local\boost_1_83_0 (or similar)
          Write-Host "Installing Boost..."
          choco install boost-msvc-14.3 -y --no-progress

      - name: Configure CMake
        shell: pwsh
        # Comment: We dynamically find the installation paths to ensure CMake does not fail.
        # This aligns with the manual setup described in the docs, but automated.
        run: |
          # Find the Boost directory in C:\local (standard Chocolatey install path)
          $boostPath = Get-ChildItem -Path "C:\local" -Filter "boost_*" | Select-Object -ExpandProperty FullName | Select-Object -First 1
          if (-not $boostPath) { Write-Error "Boost not found in C:\local"; exit 1 }
          Write-Host "Boost found at: $boostPath"

          # Create build directory
          New-Item -ItemType Directory -Force -Path "build" | Out-Null
          Set-Location build

          # Configure CMake with explicit paths
          cmake ../ `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DTOOLS=1 `
            -DSERVERS=0 `
            -DSCRIPTS=0 `
            -DWITH_WARNINGS=0 `
            -DBOOST_ROOT="$boostPath" `
            -DOPENSSL_ROOT_DIR="C:/Program Files/OpenSSL" `
            -DOPENSSL_INCLUDE_DIR="C:/Program Files/OpenSSL/include" `
            -DMYSQL_INCLUDE_DIR="C:/Program Files/MySQL/MySQL Server 8.0/include" `
            -DMYSQL_LIBRARY="C:/Program Files/MySQL/MySQL Server 8.0/lib/libmysql.lib"

      - name: Build Tools
        shell: cmd
        # Comment: Compile the specific tool targets in Release mode.
        run: |
          cd build
          cmake --build . --config Release --target mapextractor vmap4extractor vmap4assembler mmaps_generator --parallel 4

      - name: Package Tools
        shell: pwsh
        # Comment: Gather all necessary binaries and DLLs into a distribution folder.
        # This ensures the user does not need to install OpenSSL/MySQL locally to run the tools.
        run: |
          New-Item -ItemType Directory -Force -Path "TrinityTools" | Out-Null
          
          $buildBin = "build\bin\Release"
          
          Write-Host "Copying Executables..."
          Copy-Item "$buildBin\mapextractor.exe" -Destination "TrinityTools"
          Copy-Item "$buildBin\vmap4extractor.exe" -Destination "TrinityTools"
          Copy-Item "$buildBin\vmap4assembler.exe" -Destination "TrinityTools"
          Copy-Item "$buildBin\mmaps_generator.exe" -Destination "TrinityTools"
          
          Write-Host "Copying Required DLLs..."
          # OpenSSL DLLs
          Copy-Item "C:\Program Files\OpenSSL\bin\libcrypto-1_1-x64.dll" -Destination "TrinityTools"
          Copy-Item "C:\Program Files\OpenSSL\bin\libssl-1_1-x64.dll" -Destination "TrinityTools"
          
          # MySQL DLL (Often required by Common.lib)
          if (Test-Path "C:\Program Files\MySQL\MySQL Server 8.0\lib\libmysql.dll") {
              Copy-Item "C:\Program Files\MySQL\MySQL Server 8.0\lib\libmysql.dll" -Destination "TrinityTools"
          }

          Write-Host "Tools packaged successfully."

      - name: Upload Tools Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrinityCore-Windows-Tools
          path: TrinityTools
          compression-level: 9
          retention-days: 5
