name: Mirror TDB Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  mirror-tdb:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y jq curl

      - name: Find and Download latest TDB
        id: download
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Hole Release-Info von TrinityCore..."
          
          # 1. API Abfrage mit Token (verhindert Rate-Limits)
          API_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/repos/TrinityCore/TrinityCore/releases/latest)
          
          # 2. URL extrahieren - Filter angepasst auf "TDB_full_"
          # head -n 1 sorgt dafür, dass wir nur eine URL bekommen, falls mehrere passen
          LATEST_RELEASE_URL=$(echo "$API_RESPONSE" | jq -r '.assets[] | select(.name | contains("TDB_full_")) | .browser_download_url' | head -n 1)
          
          # 3. Prüfung ob URL gefunden wurde
          if [ -z "$LATEST_RELEASE_URL" ] || [ "$LATEST_RELEASE_URL" == "null" ]; then
            echo "Fehler: Keine TDB Download URL gefunden."
            echo "Geprüfter Suchbegriff: 'TDB_full_'"
            exit 1
          fi

          FILE_NAME=$(basename "$LATEST_RELEASE_URL")
          
          echo "Gefundene TDB: $FILE_NAME"
          echo "Download URL: $LATEST_RELEASE_URL"
          
          # 4. Herunterladen
          curl -L -o "$FILE_NAME" "$LATEST_RELEASE_URL"
          
          # 5. Variablen für den nächsten Schritt
          echo "file_path=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$(date +'%Y-%m-%d')-TDB" >> $GITHUB_OUTPUT

      - name: Create Release in my Repo
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.download.outputs.tag_name }}
          name: TDB Mirror ${{ steps.download.outputs.tag_name }}
          body: |
            Automatischer Mirror der offiziellen TrinityCore TDB.
            Datei: ${{ steps.download.outputs.file_path }}
            Originalquelle: https://github.com/TrinityCore/TrinityCore/releases
          files: ${{ steps.download.outputs.file_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
